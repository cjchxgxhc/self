name: Update Domain List

on:
  schedule:
    # æ¯å¤©ä¸­å›½æ—¶é—´ 4:00 AM (UTC+8) = UTC 20:00 (å‰ä¸€å¤©)
    - cron: '0 20 * * *'
  workflow_dispatch:

jobs:
  update-domain-list:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download source file
        run: |
          curl -L -o white_domain_list.php \
            "https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/refs/heads/adlist-maker/scripts/lib/white_domain_list.php"

      - name: Extract and process domains
        run: |
          python3 << 'EOF'
          import re
          import sys
          
          try:
              # è¯»å– PHP æ–‡ä»¶
              with open('white_domain_list.php', 'r', encoding='utf-8') as f:
                  content = f.read()
              
              print("ğŸ“„ å·²åŠ è½½ PHP æ–‡ä»¶")
              
              # æå–æ‰€æœ‰åŸŸå
              # åŒ¹é…æ¨¡å¼: "domain" => value, å…¶ä¸­ value æ˜¯ -1, 0, 1, æˆ– 2
              domains = []
              comments = []
              
              # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–å¸¦å¼•å·çš„åŸŸå
              # åŒ¹é…: "xxxxx" => æ•°å­— æˆ– // æ³¨é‡Š
              pattern = r'"([^"]+)"\s*=>\s*(-?\d+)\s*,?\s*(?://(.*))?'
              matches = re.findall(pattern, content)
              
              total = len(matches)
              included = 0
              excluded = 0
              
              for domain, value, comment in matches:
                  val = int(value)
                  
                  # åªä¿ç•™ value ä¸º 0 æˆ– 1 çš„åŸŸå (æ’é™¤ -1 çš„å¤±æ•ˆè§„åˆ™)
                  if val >= 0:
                      domains.append(domain)
                      included += 1
                      if comment:
                          comments.append(f"{domain} # {comment.strip()}")
                  else:
                      excluded += 1
              
              # ç§»é™¤é‡å¤é¡¹å¹¶æ’åº
              domains = sorted(set(domains))
              
              # å†™å…¥è¾“å‡ºæ–‡ä»¶
              with open('domains.txt', 'w', encoding='utf-8') as f:
                  for domain in domains:
                      f.write(domain + '\n')
              
              # è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
              print(f"\nğŸ“Š å¤„ç†ç»Ÿè®¡:")
              print(f"  â€¢ æ€»è§„åˆ™æ•°: {total}")
              print(f"  â€¢ åŒ…å«åŸŸå: {included}")
              print(f"  â€¢ æ’é™¤åŸŸå (-1): {excluded}")
              print(f"  â€¢ å»é‡å: {len(domains)}")
              print(f"\nâœ“ æˆåŠŸæå– {len(domains)} ä¸ªæœ‰æ•ˆåŸŸå")
              
          except FileNotFoundError:
              print("âŒ é”™è¯¯: æ‰¾ä¸åˆ° white_domain_list.php æ–‡ä»¶", file=sys.stderr)
              sys.exit(1)
          except Exception as e:
              print(f"âŒ å¤„ç†å‡ºé”™: {str(e)}", file=sys.stderr)
              sys.exit(1)
          EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: domain-list
          path: domains.txt

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet domains.txt 2>/dev/null; then
            echo "âœ“ æ— æ–°å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git add domains.txt
            git commit -m "chore: æ›´æ–°åŸŸåç™½åå• - $(date +%Y-%m-%d)"
            git push origin main
            echo "âœ“ å·²æ¨é€æ›´æ–°"
          fi
        continue-on-error: true

      - name: Create Release (if changes exist)
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v$(date +%Y%m%d-%H%M%S)"
          body: |
            # åŸŸåç™½åå•æ›´æ–°
            
            æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
            
            åŸŸåæ€»æ•°: $(wc -l < domains.txt)
          files: domains.txt
          draft: false
          prerelease: false
        continue-on-error: true
