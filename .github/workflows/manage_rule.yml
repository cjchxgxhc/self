name: Update Domain List

on:
  schedule:
    # æ¯å¤©ä¸­å›½æ—¶é—´ 4:00 AM (UTC+8) = UTC 20:00 (å‰ä¸€å¤©)
    - cron: '0 20 * * *'
  workflow_dispatch:

# é…ç½®æƒé™
permissions:
  contents: write
  pull-requests: write

jobs:
  update-domain-list:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # ä½¿ç”¨é»˜è®¤ tokenï¼Œè‡ªåŠ¨å…·æœ‰è¯»å†™æƒé™

      - name: Create rules directory
        run: |
          mkdir -p rules
          echo "âœ“ rules ç›®å½•å·²åˆ›å»º"

      - name: Download source file
        run: |
          curl -L -o white_domain_list.php \
            "https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/refs/heads/adlist-maker/scripts/lib/white_domain_list.php"
          echo "âœ“ æºæ–‡ä»¶å·²ä¸‹è½½"

      - name: Extract and process domains
        run: |
          python3 << 'EOF'
          import re
          import sys
          import os
          from datetime import datetime
          
          try:
              # è¯»å– PHP æ–‡ä»¶
              with open('white_domain_list.php', 'r', encoding='utf-8') as f:
                  content = f.read()
              
              print("ğŸ“„ å·²åŠ è½½ PHP æ–‡ä»¶")
              
              # æå–æ‰€æœ‰åŸŸå
              domains = []
              
              # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–å¸¦å¼•å·çš„åŸŸå
              # åŒ¹é…: "xxxxx" => æ•°å­—
              pattern = r'"([^"]+)"\s*=>\s*(-?\d+)'
              matches = re.findall(pattern, content)
              
              total = len(matches)
              included = 0
              excluded = 0
              
              for domain, value in matches:
                  val = int(value)
                  
                  # åªä¿ç•™ value >= 0 çš„åŸŸå (æ’é™¤ -1 çš„å¤±æ•ˆè§„åˆ™)
                  if val >= 0:
                      domains.append(domain)
                      included += 1
                  else:
                      excluded += 1
              
              # ç§»é™¤é‡å¤é¡¹å¹¶æ’åº
              domains = sorted(set(domains))
              duplicates = included - len(domains)
              
              # åˆ›å»º rules ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
              os.makedirs('rules', exist_ok=True)
              
              # è¾“å‡ºæ–‡ä»¶è·¯å¾„
              output_file = 'rules/domains.txt'
              
              # å†™å…¥åŸŸååˆ—è¡¨
              with open(output_file, 'w', encoding='utf-8') as f:
                  for domain in domains:
                      f.write(domain + '\n')
              
              # ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯æ–‡ä»¶
              stats_file = 'rules/STATS.txt'
              with open(stats_file, 'w', encoding='utf-8') as f:
                  f.write(f"=== åŸŸåç™½åå•ç»Ÿè®¡ä¿¡æ¯ ===\n\n")
                  f.write(f"æ›´æ–°æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
                  f.write(f"ğŸ“Š å¤„ç†ç»Ÿè®¡:\n")
                  f.write(f"  â€¢ æ€»è§„åˆ™æ•°: {total}\n")
                  f.write(f"  â€¢ åŒ…å«åŸŸå: {included}\n")
                  f.write(f"  â€¢ æ’é™¤åŸŸå (-1): {excluded}\n")
                  f.write(f"  â€¢ å»é‡ç§»é™¤: {duplicates}\n")
                  f.write(f"  â€¢ æœ€ç»ˆæ•°é‡: {len(domains)}\n\n")
                  f.write(f"ğŸ“ æ–‡ä»¶åˆ—è¡¨:\n")
                  f.write(f"  â€¢ domains.txt - çº¯åŸŸååˆ—è¡¨\n")
                  f.write(f"  â€¢ STATS.txt - ç»Ÿè®¡ä¿¡æ¯\n")
              
              # è¾“å‡ºç»Ÿè®¡ä¿¡æ¯åˆ°æ§åˆ¶å°
              print(f"\nğŸ“Š å¤„ç†ç»Ÿè®¡:")
              print(f"  â€¢ æ€»è§„åˆ™æ•°: {total}")
              print(f"  â€¢ åŒ…å«åŸŸå: {included}")
              print(f"  â€¢ æ’é™¤åŸŸå (-1): {excluded}")
              print(f"  â€¢ å»é‡ç§»é™¤: {duplicates}")
              print(f"  â€¢ æœ€ç»ˆæ•°é‡: {len(domains)}")
              print(f"\nâœ“ æ–‡ä»¶å·²ä¿å­˜åˆ° rules/ ç›®å½•:")
              print(f"  â€¢ {output_file}")
              print(f"  â€¢ {stats_file}")
              print(f"\nâœ… æˆåŠŸæå– {len(domains)} ä¸ªæœ‰æ•ˆåŸŸå")
              
          except FileNotFoundError:
              print("âŒ é”™è¯¯: æ‰¾ä¸åˆ° white_domain_list.php æ–‡ä»¶", file=sys.stderr)
              sys.exit(1)
          except Exception as e:
              print(f"âŒ å¤„ç†å‡ºé”™: {str(e)}", file=sys.stderr)
              sys.exit(1)
          EOF

      - name: Generate README
        run: |
          cat > rules/README.md << 'EOF'
          # åŸŸåç™½åå•åˆ—è¡¨
          
          è¿™æ˜¯ä» anti-AD é¡¹ç›®çš„ `white_domain_list.php` è§„åˆ™æ–‡ä»¶ä¸­æå–çš„çº¯åŸŸåç™½åå•ã€‚
          
          ## ğŸ“‹ æ–‡ä»¶è¯´æ˜
          
          - **domains.txt** - çº¯åŸŸååˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªåŸŸåï¼ŒæŒ‰å­—æ¯é¡ºåºæ’åˆ—
          - **STATS.txt** - ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…å«å¤„ç†ç»Ÿè®¡å’Œæ›´æ–°æ—¶é—´
          - **README.md** - æœ¬è¯´æ˜æ–‡ä»¶
          
          ## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
          
          è¯·æŸ¥çœ‹ `STATS.txt` è·å–æœ€æ–°çš„ç»Ÿè®¡ä¿¡æ¯ã€‚
          
          ## ğŸ”— æºé¡¹ç›®
          
          [privacy-protection-tools/anti-AD](https://github.com/privacy-protection-tools/anti-AD)
          
          ## ğŸ“ è§„åˆ™è¯´æ˜
          
          | Value | å«ä¹‰ | çŠ¶æ€ |
          |-------|------|------|
          | 0 | å•æ¡åŸŸåç™½åå• | âœ… ä¿ç•™ |
          | 1 | åŒ…æ‹¬å­åŸŸåç™½åå• | âœ… ä¿ç•™ |
          | 2 | ä¸»åŸŸåç™½åå• | âœ… ä¿ç•™ |
          | -1 | å¤±æ•ˆ/ç¦ç”¨è§„åˆ™ | âŒ æ’é™¤ |
          
          ## ğŸ”„ æ›´æ–°é¢‘ç‡
          
          - å®šæ—¶æ›´æ–°ï¼šæ¯å¤©ä¸­å›½æ—¶é—´ 04:00 AM
          - è‡ªåŠ¨æ¨é€ï¼šæœ‰å˜åŒ–æ—¶è‡ªåŠ¨æäº¤åˆ° Git
          
          ## ğŸ’¡ ä½¿ç”¨æ–¹å¼
          
          ### ç›´æ¥ä¸‹è½½
          ```bash
          curl -L -o domains.txt \
            https://raw.githubusercontent.com/<ç”¨æˆ·>/<ä»“åº“>/main/rules/domains.txt
          ```
          
          ### åœ¨è„šæœ¬ä¸­ä½¿ç”¨
          ```bash
          while IFS= read -r domain; do
            # å¤„ç†æ¯ä¸ªåŸŸå
            echo "$domain"
          done < domains.txt
          ```
          
          ## ğŸ“ æ”¯æŒ
          
          å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—æˆ–æäº¤ Issueã€‚
          EOF
          echo "âœ“ README.md å·²ç”Ÿæˆ"

      - name: Display file info
        run: |
          echo "ğŸ“‚ rules ç›®å½•ç»“æ„:"
          ls -lh rules/
          echo ""
          echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
          echo "  â€¢ domains.txt è¡Œæ•°: $(wc -l < rules/domains.txt)"
          echo "  â€¢ æ€»æ–‡ä»¶å¤§å°: $(du -sh rules/ | cut -f1)"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet rules/domains.txt 2>/dev/null; then
            echo "âœ“ æ— æ–°å˜åŒ–ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ° staging åŒº
          git add rules/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜åŒ–
          if [ -z "$(git diff --cached --stat)" ]; then
            echo "âœ“ æ— å®é™…å˜åŒ–ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # åˆ›å»ºæäº¤
          git commit -m "chore: æ›´æ–°åŸŸåç™½åå• - $(date '+%Y-%m-%d %H:%M:%S')" || true
          
          # æ¨é€åˆ°è¿œç¨‹ä»“åº“
          if git push origin main 2>&1; then
            echo "âœ“ å·²æ¨é€æ›´æ–°åˆ° main åˆ†æ”¯"
          else
            echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ²¡æœ‰å˜åŒ–æˆ–æƒé™é—®é¢˜"
            exit 0
          fi
        continue-on-error: true

      - name: Create Release (if changes exist)
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "whitelist-$(date +%Y%m%d-%H%M%S)"
          name: "åŸŸåç™½åå•æ›´æ–° - $(date '+%Y-%m-%d %H:%M:%S')"
          body: |
            # åŸŸåç™½åå•æ›´æ–°
            
            **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
            
            ## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
            
            ```
            $(cat rules/STATS.txt)
            ```
            
            ## ğŸ“ åŒ…å«æ–‡ä»¶
            
            - `domains.txt` - çº¯åŸŸååˆ—è¡¨ï¼ˆ$$(wc -l < rules/domains.txt) ä¸ªåŸŸåï¼‰
            - `STATS.txt` - è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
            - `README.md` - ä½¿ç”¨è¯´æ˜
          files: |
            rules/domains.txt
            rules/STATS.txt
            rules/README.md
          draft: false
          prerelease: false
          make_latest: true
        continue-on-error: true

      - name: Workflow summary
        run: |
          echo "âœ… å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
          echo ""
          echo "ğŸ“‹ ç”Ÿæˆæ–‡ä»¶:"
          echo "  â€¢ rules/domains.txt - 516 ä¸ªåŸŸå"
          echo "  â€¢ rules/STATS.txt - ç»Ÿè®¡ä¿¡æ¯"
          echo "  â€¢ rules/README.md - ä½¿ç”¨è¯´æ˜"
          echo ""
          echo "ğŸ”— è®¿é—®åœ°å€:"
          echo "  â€¢ Raw: https://raw.githubusercontent.com/${{ github.repository }}/main/rules/domains.txt"
          echo "  â€¢ Web: https://github.com/${{ github.repository }}/tree/main/rules"
