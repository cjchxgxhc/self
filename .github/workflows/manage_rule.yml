name: Update Domain List

on:
  schedule:
    # æ¯å¤©ä¸­å›½æ—¶é—´ 4:00 AM (UTC+8) = UTC 20:00 (å‰ä¸€å¤©)
    - cron: '0 20 * * *'
  workflow_dispatch:

# é…ç½®æƒé™
permissions:
  contents: write
  pull-requests: write

jobs:
  update-domain-list:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create rules directory
        run: |
          mkdir -p rules
          echo "âœ“ rules ç›®å½•å·²åˆ›å»º"

      - name: Download source file
        run: |
          curl -L -o white_domain_list.php \
            "https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/refs/heads/adlist-maker/scripts/lib/white_domain_list.php"
          echo "âœ“ æºæ–‡ä»¶å·²ä¸‹è½½"

      - name: Extract and process domains
        run: |
          python3 << 'EOF'
          import re
          import sys
          import os
          from datetime import datetime
          
          try:
              # è¯»å– PHP æ–‡ä»¶
              with open('white_domain_list.php', 'r', encoding='utf-8') as f:
                  content = f.read()
              
              print("ğŸ“„ å·²åŠ è½½ PHP æ–‡ä»¶")
              
              # æå–æ‰€æœ‰åŸŸå
              domains = []
              
              # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–å¸¦å¼•å·çš„åŸŸå
              # åŒ¹é…: "xxxxx" => æ•°å­—
              pattern = r'"([^"]+)"\s*=>\s*(-?\d+)'
              matches = re.findall(pattern, content)
              
              total = len(matches)
              included = 0
              excluded = 0
              
              for domain, value in matches:
                  val = int(value)
                  
                  # åªä¿ç•™ value >= 0 çš„åŸŸå (æ’é™¤ -1 çš„å¤±æ•ˆè§„åˆ™)
                  if val >= 0:
                      domains.append(domain)
                      included += 1
                  else:
                      excluded += 1
              
              # ç§»é™¤é‡å¤é¡¹å¹¶æ’åº
              domains = sorted(set(domains))
              duplicates = included - len(domains)
              
              # åˆ›å»º rules ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
              os.makedirs('rules', exist_ok=True)
              
              # è¾“å‡ºæ–‡ä»¶è·¯å¾„
              output_file = 'rules/domains.txt'
              
              # å†™å…¥åŸŸååˆ—è¡¨
              with open(output_file, 'w', encoding='utf-8') as f:
                  for domain in domains:
                      f.write(domain + '\n')
              
              print(f"âœ“ åŸŸååˆ—è¡¨å·²ä¿å­˜: {output_file}")
              
              # ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯æ–‡ä»¶
              stats_file = 'rules/STATS.txt'
              with open(stats_file, 'w', encoding='utf-8') as f:
                  f.write(f"=== åŸŸåç™½åå•ç»Ÿè®¡ä¿¡æ¯ ===\n\n")
                  f.write(f"æ›´æ–°æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
                  f.write(f"ğŸ“Š å¤„ç†ç»Ÿè®¡:\n")
                  f.write(f"  â€¢ æ€»è§„åˆ™æ•°: {total}\n")
                  f.write(f"  â€¢ åŒ…å«åŸŸå: {included}\n")
                  f.write(f"  â€¢ æ’é™¤åŸŸå (-1): {excluded}\n")
                  f.write(f"  â€¢ å»é‡ç§»é™¤: {duplicates}\n")
                  f.write(f"  â€¢ æœ€ç»ˆæ•°é‡: {len(domains)}\n\n")
                  f.write(f"ğŸ“ æ–‡ä»¶åˆ—è¡¨:\n")
                  f.write(f"  â€¢ domains.txt - çº¯åŸŸååˆ—è¡¨\n")
                  f.write(f"  â€¢ STATS.txt - ç»Ÿè®¡ä¿¡æ¯\n")
                  f.write(f"  â€¢ README.md - è¯´æ˜æ–‡æ¡£\n")
              
              print(f"âœ“ ç»Ÿè®¡ä¿¡æ¯å·²ä¿å­˜: {stats_file}")
              
              # è¾“å‡ºç»Ÿè®¡ä¿¡æ¯åˆ°æ§åˆ¶å°
              print(f"\nğŸ“Š å¤„ç†ç»Ÿè®¡:")
              print(f"  â€¢ æ€»è§„åˆ™æ•°: {total}")
              print(f"  â€¢ åŒ…å«åŸŸå: {included}")
              print(f"  â€¢ æ’é™¤åŸŸå (-1): {excluded}")
              print(f"  â€¢ å»é‡ç§»é™¤: {duplicates}")
              print(f"  â€¢ æœ€ç»ˆæ•°é‡: {len(domains)}")
              print(f"\nâœ… æˆåŠŸæå– {len(domains)} ä¸ªæœ‰æ•ˆåŸŸå")
              
          except FileNotFoundError:
              print("âŒ é”™è¯¯: æ‰¾ä¸åˆ° white_domain_list.php æ–‡ä»¶", file=sys.stderr)
              sys.exit(1)
          except Exception as e:
              print(f"âŒ å¤„ç†å‡ºé”™: {str(e)}", file=sys.stderr)
              sys.exit(1)
          EOF

      - name: Generate README
        run: |
          cat > rules/README.md << 'EOF'
          # åŸŸåç™½åå•åˆ—è¡¨
          
          è¿™æ˜¯ä» anti-AD é¡¹ç›®çš„ `white_domain_list.php` è§„åˆ™æ–‡ä»¶ä¸­æå–çš„çº¯åŸŸåç™½åå•ã€‚
          
          ## ğŸ“‹ æ–‡ä»¶è¯´æ˜
          
          - **domains.txt** - çº¯åŸŸååˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªåŸŸåï¼ŒæŒ‰å­—æ¯é¡ºåºæ’åˆ—
          - **STATS.txt** - ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…å«å¤„ç†ç»Ÿè®¡å’Œæ›´æ–°æ—¶é—´
          - **README.md** - æœ¬è¯´æ˜æ–‡ä»¶
          
          ## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
          
          è¯·æŸ¥çœ‹ `STATS.txt` è·å–æœ€æ–°çš„ç»Ÿè®¡ä¿¡æ¯ã€‚
          
          ## ğŸ”— æºé¡¹ç›®
          
          [privacy-protection-tools/anti-AD](https://github.com/privacy-protection-tools/anti-AD)
          
          ## ğŸ“ è§„åˆ™è¯´æ˜
          
          | Value | å«ä¹‰ | çŠ¶æ€ |
          |-------|------|------|
          | 0 | å•æ¡åŸŸåç™½åå• | âœ… ä¿ç•™ |
          | 1 | åŒ…æ‹¬å­åŸŸåç™½åå• | âœ… ä¿ç•™ |
          | 2 | ä¸»åŸŸåç™½åå• | âœ… ä¿ç•™ |
          | -1 | å¤±æ•ˆ/ç¦ç”¨è§„åˆ™ | âŒ æ’é™¤ |
          
          ## ğŸ”„ æ›´æ–°é¢‘ç‡
          
          - å®šæ—¶æ›´æ–°ï¼šæ¯å¤©ä¸­å›½æ—¶é—´ 04:00 AM
          - è‡ªåŠ¨æ¨é€ï¼šæœ‰å˜åŒ–æ—¶è‡ªåŠ¨æäº¤åˆ° Git
          
          ## ğŸ’¡ ä½¿ç”¨æ–¹å¼
          
          ### ç›´æ¥ä¸‹è½½
          ```bash
          curl -L -o domains.txt \
            https://raw.githubusercontent.com/<ç”¨æˆ·>/<ä»“åº“>/main/rules/domains.txt
          ```
          
          ### åœ¨è„šæœ¬ä¸­ä½¿ç”¨
          ```bash
          while IFS= read -r domain; do
            # å¤„ç†æ¯ä¸ªåŸŸå
            echo "$domain"
          done < domains.txt
          ```
          
          ## ğŸ“ æ”¯æŒ
          
          å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—æˆ–æäº¤ Issueã€‚
          EOF
          echo "âœ“ README.md å·²ç”Ÿæˆ"

      - name: Display file info
        run: |
          echo "ğŸ“‚ rules ç›®å½•ç»“æ„:"
          ls -lh rules/
          echo ""
          echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
          echo "  â€¢ domains.txt è¡Œæ•°: $(wc -l < rules/domains.txt)"
          echo "  â€¢ æ€»æ–‡ä»¶å¤§å°: $(du -sh rules/ | cut -f1)"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "ğŸ” æ£€æŸ¥æ–‡ä»¶å˜åŒ–..."
          
          # æ£€æŸ¥ rules ç›®å½•æ˜¯å¦æœ‰æ–‡ä»¶
          if [ ! -f "rules/domains.txt" ]; then
            echo "âŒ é”™è¯¯: rules/domains.txt ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ·»åŠ æ‰€æœ‰ rules ç›®å½•çš„æ–‡ä»¶åˆ° staging åŒº
          git add rules/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å¾…æäº¤çš„æ–‡ä»¶
          if git diff --cached --quiet; then
            echo "â„¹ï¸  æ— æ–°å˜åŒ–ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # æ˜¾ç¤ºå³å°†æäº¤çš„æ–‡ä»¶
          echo "ğŸ“ å¾…æäº¤æ–‡ä»¶:"
          git diff --cached --name-only | sed 's/^/  â€¢ /'
          
          # åˆ›å»ºæäº¤
          COMMIT_MSG="chore: æ›´æ–°åŸŸåç™½åå• - $(date '+%Y-%m-%d %H:%M:%S')"
          if ! git commit -m "$COMMIT_MSG"; then
            echo "âŒ æäº¤å¤±è´¥"
            exit 1
          fi
          
          # æ¨é€åˆ°è¿œç¨‹ä»“åº“
          echo "ğŸ“¤ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
          if ! git push origin main; then
            echo "âŒ æ¨é€å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… å·²æ¨é€æ›´æ–°åˆ° main åˆ†æ”¯"
          echo ""
          echo "ğŸ“Š å·²æäº¤çš„æ–‡ä»¶:"
          git diff --name-only HEAD~1 HEAD | sed 's/^/  â€¢ /'
        continue-on-error: false

      - name: Workflow summary
        if: always()
        run: |
          echo ""
          echo "âœ… å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ ç”Ÿæˆçš„æ–‡ä»¶:"
          if [ -f "rules/domains.txt" ]; then
            echo "  âœ“ rules/domains.txt ($(wc -l < rules/domains.txt) ä¸ªåŸŸå)"
          fi
          if [ -f "rules/STATS.txt" ]; then
            echo "  âœ“ rules/STATS.txt"
          fi
          if [ -f "rules/README.md" ]; then
            echo "  âœ“ rules/README.md"
          fi
          echo ""
          echo "ğŸ”— è®¿é—®åœ°å€:"
          echo "  â€¢ Raw: https://raw.githubusercontent.com/${{ github.repository }}/main/rules/domains.txt"
          echo "  â€¢ Web: https://github.com/${{ github.repository }}/tree/main/rules"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
